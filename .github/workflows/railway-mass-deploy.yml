name: Railway Mass Deployment

on:
  workflow_dispatch:
    inputs:
      practice_id:
        description: 'Practice ID (e.g., advanced-spine-care)'
        required: true
        type: string
      practice_name:
        description: 'Practice Name (e.g., Advanced Spine Care)'
        required: true
        type: string
      deploy_all:
        description: 'Deploy all practices (ignores practice_id/name above)'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main ]
    paths: [ 'src/lib/practice-config.ts' ]

jobs:
  deploy-single:
    if: ${{ github.event_name == 'workflow_dispatch' && !inputs.deploy_all }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Fully Automated Railway Project
        run: |
          echo 'üöÄ Fully automated deployment for ${{ inputs.practice_name }} (${{ inputs.practice_id }})'
          
          # Create Railway project
          PROJECT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { projectCreate(input: { name: \"${{ inputs.practice_id }}-demo\" }) { id name } }"}' \
            https://backboard.railway.app/graphql/v2)
          
          echo "Project response: $PROJECT_RESPONSE"
          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r '.data.projectCreate.id // empty')
          
          if [ -z "$PROJECT_ID" ]; then
            echo "‚ùå Failed to create project"
            exit 1
          fi
          
          echo "‚úÖ Created project: $PROJECT_ID"
          
          # Create service with practice-specific name
          SERVICE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { serviceCreate(input: { projectId: \\\"$PROJECT_ID\\\", name: \\\"${{ inputs.practice_id }}-demo\\\" }) { id name } }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Service response: $SERVICE_RESPONSE"
          SERVICE_ID=$(echo "$SERVICE_RESPONSE" | jq -r '.data.serviceCreate.id // empty')
          
          if [ -z "$SERVICE_ID" ]; then
            echo "‚ùå Failed to create service"
            exit 1
          fi
          
          echo "‚úÖ Created service: $SERVICE_ID"
          
          # Connect GitHub repository
          CONNECT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { serviceConnect(id: \\\"$SERVICE_ID\\\", input: { repo: \\\"jomarcello/Agentsdemo\\\", branch: \\\"main\\\" }) { id } }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Connect response: $CONNECT_RESPONSE"
          
          # Set PRACTICE_ID environment variable
          PRACTICE_VAR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { variableUpsert(input: { serviceId: \\\"$SERVICE_ID\\\", name: \\\"PRACTICE_ID\\\", value: \\\"${{ inputs.practice_id }}\\\" }) { id name value } }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Practice variable response: $PRACTICE_VAR_RESPONSE"
          
          # Set NODE_ENV environment variable
          NODE_ENV_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { variableUpsert(input: { serviceId: \\\"$SERVICE_ID\\\", name: \\\"NODE_ENV\\\", value: \\\"production\\\" }) { id name value } }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Node env response: $NODE_ENV_RESPONSE"
          
          # Set PORT environment variable (sometimes needed for Railway)
          PORT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { variableUpsert(input: { serviceId: \\\"$SERVICE_ID\\\", name: \\\"PORT\\\", value: \\\"3000\\\" }) { id name value } }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Port response: $PORT_RESPONSE"
          
          # Also try to create domain immediately after service setup
          echo "üåê Attempting early domain creation..."
          EARLY_DOMAIN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { serviceDomainCreate(input: { serviceId: \\\"$SERVICE_ID\\\" }) { id domain } }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Early domain response: $EARLY_DOMAIN_RESPONSE"
          
          # Wait a moment for setup to complete
          sleep 10
          
          # Trigger deployment
          DEPLOY_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { serviceInstanceDeploy(serviceId: \\\"$SERVICE_ID\\\", latestCommit: true) }\"}" \
            https://backboard.railway.app/graphql/v2)
          
          echo "Deploy response: $DEPLOY_RESPONSE"
          
          # Railway generates predictable URLs: {service-name}-{environment}.up.railway.app
          DEPLOYMENT_URL="https://${{ inputs.practice_id }}-demo-production.up.railway.app"
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Fully automated deployment initiated!"
          echo "üîó Project URL: https://railway.app/project/$PROJECT_ID"  
          echo "üåê App URL: $DEPLOYMENT_URL"
          echo "‚è≥ Deployment will be ready in ~2-3 minutes"
          
          # Wait for deployment to complete - keep checking until SUCCESS
          echo "‚è≥ Waiting for deployment to complete..."
          DEPLOYMENT_STATUS="unknown"
          CHECK_COUNT=0
          
          while [ "$DEPLOYMENT_STATUS" != "SUCCESS" ] && [ "$DEPLOYMENT_STATUS" != "FAILED" ]; do
            sleep 30
            CHECK_COUNT=$((CHECK_COUNT + 1))
            ELAPSED_TIME=$((CHECK_COUNT * 30))
            echo "‚è≥ Check $CHECK_COUNT (${ELAPSED_TIME}s elapsed): Checking deployment status..."
            
            # Check deployment status and get service details
            SERVICE_STATUS=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"query { service(id: \\\"$SERVICE_ID\\\") { id name activeDeployment { id status url } } }\"}" \
              https://backboard.railway.app/graphql/v2)
            
            echo "Service status response: $SERVICE_STATUS"
            
            DEPLOYMENT_STATUS=$(echo "$SERVICE_STATUS" | jq -r '.data.service.activeDeployment.status // "unknown"')
            EXISTING_URL=$(echo "$SERVICE_STATUS" | jq -r '.data.service.activeDeployment.url // empty')
            
            echo "Deployment status: $DEPLOYMENT_STATUS"
            
            if [ "$DEPLOYMENT_STATUS" = "SUCCESS" ]; then
              echo "‚úÖ Deployment completed successfully after ${ELAPSED_TIME} seconds!"
              break
            elif [ "$DEPLOYMENT_STATUS" = "FAILED" ]; then
              echo "‚ùå Deployment failed after ${ELAPSED_TIME} seconds!"
              break
            else
              echo "‚è≥ Deployment status: $DEPLOYMENT_STATUS, waiting 30 more seconds..."
            fi
            
            # Safety check - if over 20 minutes, something is wrong
            if [ "$CHECK_COUNT" -gt 40 ]; then
              echo "‚ö†Ô∏è Deployment taking longer than 20 minutes. Current status: $DEPLOYMENT_STATUS"
              echo "üîó Check Railway dashboard: https://railway.app/project/$PROJECT_ID"
            fi
          done
          
          if [ "$DEPLOYMENT_STATUS" = "SUCCESS" ]; then
            echo "‚úÖ Deployment successful!"
            
            if [ -n "$EXISTING_URL" ] && [ "$EXISTING_URL" != "null" ] && [ "$EXISTING_URL" != "empty" ]; then
              echo "‚úÖ Railway URL already exists: $EXISTING_URL"
              DEPLOYMENT_URL="$EXISTING_URL"
            else
              echo "üåê No existing URL found, generating public Railway domain..."
              echo "Service ID for domain generation: $SERVICE_ID"
              
              # Create a public domain for the service
              DOMAIN_RESPONSE=$(curl -s -X POST \
                -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d "{\"query\":\"mutation { serviceDomainCreate(input: { serviceId: \\\"$SERVICE_ID\\\" }) { id domain } }\"}" \
                https://backboard.railway.app/graphql/v2)
              
              echo "Domain generation response: $DOMAIN_RESPONSE"
              
              # Check for errors in the response
              DOMAIN_ERROR=$(echo "$DOMAIN_RESPONSE" | jq -r '.errors[0].message // empty')
              if [ -n "$DOMAIN_ERROR" ] && [ "$DOMAIN_ERROR" != "empty" ]; then
                echo "‚ùå Domain generation error: $DOMAIN_ERROR"
              fi
              
              GENERATED_DOMAIN=$(echo "$DOMAIN_RESPONSE" | jq -r '.data.serviceDomainCreate.domain // empty')
              
              if [ -n "$GENERATED_DOMAIN" ] && [ "$GENERATED_DOMAIN" != "null" ] && [ "$GENERATED_DOMAIN" != "empty" ]; then
                DEPLOYMENT_URL="https://$GENERATED_DOMAIN"
                echo "‚úÖ Generated Railway URL: $DEPLOYMENT_URL"
              else
                echo "‚ö†Ô∏è Could not generate domain, attempting alternative method..."
                
                # Try to get any existing domains for this service
                DOMAINS_RESPONSE=$(curl -s -X POST \
                  -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  -d "{\"query\":\"query { service(id: \\\"$SERVICE_ID\\\") { domains { nodes { domain } } } }\"}" \
                  https://backboard.railway.app/graphql/v2)
                
                echo "Existing domains response: $DOMAINS_RESPONSE"
                EXISTING_DOMAIN=$(echo "$DOMAINS_RESPONSE" | jq -r '.data.service.domains.nodes[0].domain // empty')
                
                if [ -n "$EXISTING_DOMAIN" ] && [ "$EXISTING_DOMAIN" != "null" ] && [ "$EXISTING_DOMAIN" != "empty" ]; then
                  DEPLOYMENT_URL="https://$EXISTING_DOMAIN"
                  echo "‚úÖ Found existing domain: $DEPLOYMENT_URL"
                else
                  echo "‚ö†Ô∏è Using fallback URL pattern"
                  DEPLOYMENT_URL="https://${{ inputs.practice_id }}-demo-production.up.railway.app"
                fi
              fi
            fi
            
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            
            # Test the final URL
            echo "üß™ Testing final URL: $DEPLOYMENT_URL"
            sleep 15  # Give domain a moment to propagate
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' "$DEPLOYMENT_URL" || echo '000')
            echo "http_status=$STATUS" >> $GITHUB_OUTPUT
            
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ URL is live and working: $DEPLOYMENT_URL"
            else
              echo "‚ö†Ô∏è URL may still be propagating. Status: $STATUS"
            fi
            
          else
            echo "‚ö†Ô∏è Deployment status: $DEPLOYMENT_STATUS"
            echo "üîó Check Railway dashboard: https://railway.app/project/$PROJECT_ID"
            DEPLOYMENT_URL="https://${{ inputs.practice_id }}-demo-production.up.railway.app"
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          fi

      - name: Test deployment
        run: |
          echo "üß™ Testing deployment..."
          echo "Practice: ${{ inputs.practice_name }}"
          echo "URL: ${{ steps.deploy.outputs.deployment_url }}"
          echo "Status: ${{ steps.deploy.outputs.http_status }}"

  deploy-auto:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Advanced Spine Care to Railway
        uses: docker://ghcr.io/railwayapp/cli:latest
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        with:
          entrypoint: sh
          args: |
            -c "
            echo 'üöÄ Auto-deploying Advanced Spine Care (advanced-spine-care)'
            
            # Install required tools
            apk add --no-cache jq curl
            
            # Initialize Railway project
            railway init -n 'advanced-spine-care-demo'
            
            # Set environment variables
            railway variables --set 'PRACTICE_ID=advanced-spine-care'
            railway variables --set 'NODE_ENV=production'
            
            # Deploy
            railway up --detach
            
            # Get deployment URL
            DEPLOYMENT_URL=$(railway status --json | jq -r '.deployments[0].url // empty')
            if [ -z \"$DEPLOYMENT_URL\" ]; then
              DEPLOYMENT_URL=\"https://advanced-spine-care-demo-production.up.railway.app\"
            fi
            
            echo \"‚úÖ Auto-deployment complete: $DEPLOYMENT_URL\"
            echo \"deployment_url=$DEPLOYMENT_URL\" >> $GITHUB_OUTPUT
            
            # Test HTTP status
            sleep 30
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' \"$DEPLOYMENT_URL\" || echo '000')
            echo \"üîç HTTP Status: $STATUS\"
            echo \"http_status=$STATUS\" >> $GITHUB_OUTPUT
            "

      - name: Test auto deployment
        run: |
          echo "üß™ Testing auto deployment..."
          echo "Practice: Advanced Spine Care"
          echo "URL: https://advanced-spine-care-demo-production.up.railway.app"

  deploy-all:
    if: ${{ inputs.deploy_all }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        practice:
          - { id: 'spinealign', name: 'SpineAlign Center' }
          - { id: 'smith', name: 'Smith Chiropractic' }
          - { id: 'smart-cosmetic', name: 'Smart Cosmetic Clinic' }
          - { id: 'beautymed', name: 'BeautyMed Clinic' }
          - { id: 'advanced-spine-care', name: 'Advanced Spine Care' }
          - { id: '111-harley-street', name: '111 Harley Street' }
          - { id: '152-harley-street', name: '152 Harley Street' }
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ${{ matrix.practice.name }}
        uses: docker://ghcr.io/railwayapp/cli:latest
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        with:
          entrypoint: sh
          args: |
            -c "
            echo 'üöÄ Deploying ${{ matrix.practice.name }} (${{ matrix.practice.id }})'
            
            # Install required tools
            apk add --no-cache jq curl
            
            # Initialize Railway project
            railway init -n '${{ matrix.practice.id }}-demo'
            
            # Set environment variables
            railway variables --set 'PRACTICE_ID=${{ matrix.practice.id }}'
            railway variables --set 'NODE_ENV=production'
            
            # Deploy
            railway up --detach
            
            # Get deployment URL
            DEPLOYMENT_URL=$(railway status --json | jq -r '.deployments[0].url // empty')
            if [ -z \"$DEPLOYMENT_URL\" ]; then
              DEPLOYMENT_URL=\"https://${{ matrix.practice.id }}-demo-production.up.railway.app\"
            fi
            
            echo \"‚úÖ ${{ matrix.practice.name }} deployed: $DEPLOYMENT_URL\"
            
            # Test HTTP status
            sleep 30
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' \"$DEPLOYMENT_URL\" || echo '000')
            echo \"üîç ${{ matrix.practice.name }} Status: $STATUS\"
            "

  summary:
    if: ${{ inputs.deploy_all }}
    needs: deploy-all
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "üéâ Mass deployment complete!"
          echo "Deployed practices:"
          echo "- SpineAlign Center: https://spinealign-demo-production.up.railway.app"
          echo "- Smith Chiropractic: https://smith-demo-production.up.railway.app"  
          echo "- Smart Cosmetic Clinic: https://smart-cosmetic-demo-production.up.railway.app"
          echo "- BeautyMed Clinic: https://beautymed-demo-production.up.railway.app"
          echo "- Advanced Spine Care: https://advanced-spine-care-demo-production.up.railway.app"
          echo "- 111 Harley Street: https://111-harley-street-demo-production.up.railway.app"
          echo "- 152 Harley Street: https://152-harley-street-demo-production.up.railway.app"